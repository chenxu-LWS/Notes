# CAP理论

* C - Consistency一致性：分布式系统的最终效果等同于同一份**最新**数据副本
* A - Availability可用性：每次请求都能获取到**正常的响应**，但**不保证响应的数据是最新**
* P - Partition Tolerance分区容错性：分区是指整个系统中的机器部分**网络**不通，无法通信。可以容忍任意数量的消息，由于节点间的**网络问题**导致的**丢失或延迟**，过程中系统仍正常运行。

对于一个分布式系统，不可能完全满足CAP三个特性，最多只能满足其中两个。

<img src="/Users/liuwenshuo/Documents/Notes/Daily_study/image-20220520165120002.png" alt="image-20220520165120002" style="zoom: 67%;" />

## 理解

1. 如果网络完全可靠，即没有网络分区和网络波动时，我们无须为了P而舍弃C或A；否则为了保证P，必须**降级**C或A中的某一个。

   > 举个例子，一个Client要向一个分布式存储系统写入数据，可以有两种设计方式。
   >
   > 1. 一写：只要有一个副本正确写入就返回成功。
   >
   >    此时当网络分区时，三台机器就可能出现不一致，无法保证C；但由于可以正常返回写入成功的状态，因此保证A。
   >
   > 2. 多写：只有多个副本都写入成功才返回成功。
   >
   >    此时当网络分区时，多台副本的数据一定是一致的，保证了C；但无法进行写入，因此无法保证A。

2. 在分布式系统中，P一定是存在的，一旦出现网络分区，C（一致性）和A（可用性）就必须抛弃一个。

   > 对于NoSQL，我们更关注可用性，因此往往设计成AP系统；
   >
   > 对于分布式关系型数据库，更关注一致性，因此设计成CP系统。

   虽然如此，分布式关系型数据库也仍然需要保证可用性，但只能达到“**高可用性**”，一般具备99.999%以上的可用性。

3. 高可用衡量指标
   * 恢复点目标（RPO - Recovery Point Objective）：指数据库在出现故障时会丢失多长时间的数据。（一般是0）
   * 恢复时间目标（RTO - Recovery Time Objective）：指数据库发生故障到恢复正常所需的时间。（一般是分钟级别）

## 从CAP视角看分布式的方案

1. Quorum Replication

   三个关键参数：N（副本数）、W（写入成功的副本数）、R（读取成功的副本数）

   一个原则：W + R > N

   * e.g. N = 3, W = 1, R = 3：写可用AP，读一致CP
   * e.g. N = 3, W = 3, R = 1：写一致CP，读可以AP

2. Consensus Algorithm

   副本之间交互，leader提供读写，leader选举过程短暂不可用。

   因此整体是一个CP+High Availability的解决方案