# RAFT

## 概要

Raft是一种用来管理复制状态机中日志复制的共识算法。Raft比Paxos要更易于理解，且可以和Paxos达到相同的效果和效率。Raft通过将Leader选举、日志复制（基于复制状态机的日志）、安全（这里安全是指不会产生错误的结果）等共识算法的关键因素进行分离，使得算法更容易理解；通过更强的一致性要求使得我们不需要考虑多种不一致的状态。

## Sec1 Intro

共识算法可以实现集群中的容错，在部分机器出现故障时整个系统可以进行自动化的恢复并正确响应外部请求。实际上现在大多数的共识算法都是基于Paxos或是被Paxos所影响的。Paxos已经成为学习共识算法的基础。

但Paxos算法本身较难理解，且开发者为了基于Paxos实现一套真正的可用系统需要做出很多复杂的改变。因此作者希望提供一个更加简单的算法用于系统构建和教育。作者的首要目标就是改进算法的可理解性；与此同时希望算法可以促进对分布式系统架构师的思路发展。这样更能解释为什么此算法可以正确工作。

最终产出Raft算法。这个算法利用特殊的技术改进了Paxos算法的可理解性。

* **分离**（Decomposition）：Raft将Leader选举、日志复制、安全 等模块进行了分离
* **状态简化**（State Space Reduction）：相比Paxos，Raft减少了不同server之间产生不一致的情况

Raft的特色如下：

* **Strong Leader**：Raft中的Leader相比其他共识算法有着更强的作用。例如日志条目（Log Entries）只会从Leader流向其他其他服务器。这极大的简化了日志复制的管理，使得算法更容易理解。
* **Leader选举**：Raft使用随机计时器进行Leader选举。这需要给心跳机制增加一定的特殊机制，但却简单快捷地解决了冲突。
* **Membership Changes**：Raft在进行变更集群中服务器的机制中，用到了一种新的**联合共识算法**（Joint Consensus Algo）。这使得配置变更过程中，系统不会停摆，而是重叠（Overlap）。

论文整体结构：

* Sec 2 ：介绍复制状态机（Replicated State Machine）问题
* Sec 3：讨论Paxos的优缺点
* Sec 4：描述我们对可理解性的常规理解
* Sec 5～7：Raft共识算法的实现
* Sec 8：功能、性能评估
* Sec 9：讨论相关工作

> 这篇并没有具体介绍客户端如何与系统进行交互、如何回收Raft日志的空间

## Sec 2 复制状态机

> 这里不逐句翻译对复制状态机的介绍，课程中有专门提到复制状态机。

状态转移、复制状态机（Replicated State Machine）是分布式系统中利用复制解决容错问题的两种重要方法。而共识算法往往与复制状态机的复制方式结合。

<img src="/Users/liuwenshuo/Documents/Notes/Daily_study/image-20220523145819642.png" alt="image-20220523145819642" style="zoom:67%;" />

上图是共识算法与复制状态机的结合方式架构。

以单Leader的系统，如GFS、HDFS等为例，通常使用一个与副本分离的Master节点进行副本Leader的选举并在这个节点中存储配置信息，使得在Leader故障时可以维持系统正常响应。

复制状态机的核心就是，在每个副本中保存相同的指令日志，每个指令日志包含多条有序的指令。每个副本维护着相同且顺序相同的日志序列，因此每个状态机都应该得到相同的结果，并产生相同的输出。

在此基础上，**共识算法的作用就是要维持不同副本的日志是一致的**。Leader的共识算法模块（Consensus Module）直接与Client交互，接收发来的命令并将这些命令添加到日志中。同时这个模块还要与其他副本的模块进行交互，确保日志的一致性。一旦正确的完成了复制，每台副本状态机都会按序执行这些命令，最终产出并返回结果给Client。因此这些副本**对外展示仿佛是一个单机的、高度可靠的状态机**。

共识算法往往有以下属性：

* **确保安全性**：安全是指不会返回错误的结果。容忍任何错误环境，包括网络延迟、网络分区、丢包、重复、重排序等等
* 只要**多于半数的机器可用，整个系统就完全可用**：
* **不依赖计时进行日志一致性的保证**：错误的时钟问题、消息延迟问题严重时可能导致可用性问题。
* 通常情况下，只要集群中过半的机器进行了响应就认为一条指令执行完毕，少量速度较慢的副本不会影响整个系统的可用性

## Sec 3 Paxos的问题

